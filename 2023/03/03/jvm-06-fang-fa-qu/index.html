

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid5.png">
  <link rel="icon" href="/img/fluid5.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Zbiao">
  <meta name="keywords" content="">
  
    <meta name="description" content="1、堆、栈、方法区交互关系 从线程共享与否的角度来看 ThreadLocal：如何保证多个线程在并发环境下的安全性？典型场景就是数据库连接管理，以及会话管理。  栈、堆、方法区的交互关系 下面涉及了对象的访问定位  Person 类的 .class 信息存放在方法区中 person 变量存放在 Java 栈的局部变量表中 真正的 person 对象存放在 Java 堆中 在 person 对象中，">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM-06-方法区">
<meta property="og:url" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/index.html">
<meta property="og:site_name" content="Zbiao | 多吃一点">
<meta property="og:description" content="1、堆、栈、方法区交互关系 从线程共享与否的角度来看 ThreadLocal：如何保证多个线程在并发环境下的安全性？典型场景就是数据库连接管理，以及会话管理。  栈、堆、方法区的交互关系 下面涉及了对象的访问定位  Person 类的 .class 信息存放在方法区中 person 变量存放在 Java 栈的局部变量表中 真正的 person 对象存放在 Java 堆中 在 person 对象中，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308164842524.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308165116291.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308165213694.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308170147753.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308170317765.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308171307163.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308171348710.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308172316645.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308172826239.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308173007613.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180004431.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180051615.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180136460.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180202251.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180216598.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180242453.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180259205.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180314684.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180349731.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180403045.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180429925.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180442744.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180459139.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180605746.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180646611.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308180703378.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309122916648.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309122933796.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309123036208.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309125449719.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309130424648.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309130904791.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309130923700.png">
<meta property="og:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230309131244337.png">
<meta property="article:published_time" content="2023-03-03T08:32:47.000Z">
<meta property="article:modified_time" content="2023-03-09T06:09:39.238Z">
<meta property="article:author" content="Zbiao">
<meta property="article:tag" content="java">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/image-20230308164842524.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>JVM-06-方法区 - Zbiao | 多吃一点</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css# 滚动条颜色.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"bigotry-zb.github.io.git","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ZBiao&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default3.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="JVM-06-方法区"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-03 16:32" pubdate>
          2023年3月3日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          116 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="JVM"
        id="heading-18b5a217c4dad25662d3a05edb0e39d7" role="tab" data-toggle="collapse" href="#collapse-18b5a217c4dad25662d3a05edb0e39d7"
        aria-expanded="true"
      >
        JVM
        <span class="list-group-count">(11)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-18b5a217c4dad25662d3a05edb0e39d7"
           role="tabpanel" aria-labelledby="heading-18b5a217c4dad25662d3a05edb0e39d7">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2022/10/21/jvm-01-jvm-yu-java-ti-xi-jie-gou/" title="JVM-01-JVM与Java体系结构"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-01-JVM与Java体系结构</span>
        </a>
      
    
      
      
        <a href="/2022/10/24/jvm-02-lei-jia-zai-zi-xi-tong/" title="JVM-02-类加载子系统"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-02-类加载子系统</span>
        </a>
      
    
      
      
        <a href="/2022/10/27/jvm-03-yun-xing-shi-shu-ju-qu/" title="JVM-03-运行时数据区"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-03-运行时数据区</span>
        </a>
      
    
      
      
        <a href="/2022/10/31/jvm-04-xu-ni-ji-zhan/" title="JVM-04-虚拟机栈"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-04-虚拟机栈</span>
        </a>
      
    
      
      
        <a href="/2023/03/02/jvm-05-dui/" title="JVM-05-堆"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-05-堆</span>
        </a>
      
    
      
      
        <a href="/2023/03/03/jvm-06-fang-fa-qu/" title="JVM-06-方法区"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">JVM-06-方法区</span>
        </a>
      
    
      
      
        <a href="/2023/03/04/jvm-07-dui-xiang-de-shi-li-hua-nei-cun-bu-ju-yu-fang-wen-ding-wei/" title="JVM-07-对象的实例化内存布局与访问定位"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-07-对象的实例化内存布局与访问定位</span>
        </a>
      
    
      
      
        <a href="/2023/03/05/jvm-08-zhi-xing-yin-qing/" title="JVM-08-执行引擎"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-08-执行引擎</span>
        </a>
      
    
      
      
        <a href="/2023/03/07/jvm-09-stringtable-zi-fu-chuan-chang-liang-chi/" title="JVM-09-StringTable(字符串常量池)"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-09-StringTable(字符串常量池)</span>
        </a>
      
    
      
      
        <a href="/2023/03/08/jvm-10-la-ji-hui-shou-gai-shu/" title="JVM-10-垃圾回收概述"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-10-垃圾回收概述</span>
        </a>
      
    
      
      
        <a href="/2023/03/10/jvm-11-la-ji-hui-shou-xiang-guan-gai-nian/" title="JVM-11-垃圾回收相关概念"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">JVM-11-垃圾回收相关概念</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">JVM-06-方法区</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1、堆、栈、方法区交互关系">1、堆、栈、方法区交互关系</h2>
<p><strong>从线程共享与否的角度来看</strong></p>
<p>ThreadLocal：如何保证多个线程在并发环境下的安全性？典型场景就是数据库连接管理，以及会话管理。</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308164842524.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>栈、堆、方法区的交互关系</strong></p>
<p><strong>下面涉及了对象的访问定位</strong></p>
<ol>
<li>Person 类的 .class 信息存放在方法区中</li>
<li>person 变量存放在 Java 栈的局部变量表中</li>
<li>真正的 person 对象存放在 Java 堆中</li>
<li>在 person 对象中，有个指针指向方法区中的 person 类型数据，表明这个 person 对象是用方法区中的 Person 类 new 出来的</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308165116291.png" srcset="/img/loading.gif" lazyload alt></p>
<h2 id="2、方法区的理解">2、方法区的理解</h2>
<h3 id="1、方法区的基本理解">1、方法区的基本理解</h3>
<ol>
<li>尽管所有的方法区在逻辑上是属于堆的一部分，但一些简单的实现可能不会选择去进行垃圾收集或者进行压缩。但对于HotSpotJVM而言，方法区还有一个别名叫做Non-Heap（非堆），目的就是要和堆分开。</li>
<li>所以，<strong>方法区可以看作是一块独立于Java堆的内存空间</strong>。</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308165213694.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>方法区主要存放的是 Class，而堆中主要存放的是实例化的对象</strong></p>
<ol>
<li>方法区（Method Area）与Java堆一样，是各个线程共享的内存区域。多个线程同时加载统一个类时，只能有一个线程能加载该类，其他线程只能等等待该线程加载完毕，然后直接使用该类，即类只能加载一次。</li>
<li>方法区在JVM启动的时候被创建，并且它的实际的物理内存空间中和Java堆区一样都可以是不连续的。</li>
<li>方法区的大小，跟堆空间一样，可以选择固定大小或者可扩展。</li>
<li>方法区的大小决定了系统可以保存多少个类，如果系统定义了太多的类，导致方法区溢出，虚拟机同样会抛出内存溢出错误：<code>java.lang.OutofMemoryError:PermGen space</code>或者<code>java.lang.OutOfMemoryError:Metaspace</code>
<ul>
<li>加载大量的第三方的jar包</li>
<li>Tomcat部署的工程过多（30~50个）</li>
<li>大量动态的生成反射类</li>
</ul>
</li>
<li>关闭JVM就会释放这个区域的内存。</li>
</ol>
<h3 id="2、HotSpot方法区演进">2、HotSpot方法区演进</h3>
<ol>
<li>在 JDK7 及以前，习惯上把方法区，称为永久代。JDK8开始，使用元空间取代了永久代。我们可以将方法区类比为Java中的接口，将永久代或元空间类比为Java中具体的实现类</li>
<li>本质上，方法区和永久代并不等价。仅是对Hotspot而言的可以看作等价。《Java虚拟机规范》对如何实现方法区，不做统一要求。
<ul>
<li>现在来看，当年使用永久代，不是好的idea。导致Java程序更容易OOm（超过-XX:MaxPermsize上限）</li>
</ul>
</li>
<li>而到了JDK8，完全废弃了永久代的概念，改用与JRockit、J9一样在本地内存中实现的元空间（Metaspace）来代替</li>
<li>元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代最大的区别在于：<strong>元空间不在虚拟机设置的内存中，而是使用本地内存</strong>。</li>
<li>永久代、元空间二者并不只是名字变了，内部结构也调整了</li>
<li>如果方法区无法满足新的内存分配需求时，将抛出OOM异常</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308170147753.png" srcset="/img/loading.gif" lazyload alt></p>
<h2 id="3、设置方法区大小与-OOM">3、设置方法区大小与 OOM</h2>
<p>方法区的大小不必是固定的，JVM可以根据应用的需要动态调整。</p>
<h3 id="1、JDK7及以前-永久代">1、JDK7及以前(永久代)</h3>
<ol>
<li>通过-XX:Permsize来设置永久代初始分配空间。默认值是20.75M</li>
<li>-XX:MaxPermsize来设定永久代最大可分配空间。32位机器默认是64M，64位机器模式是82M</li>
<li>当JVM加载的类信息容量超过了这个值，会报异常OutofMemoryError:PermGen space。</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308170317765.png" srcset="/img/loading.gif" lazyload alt></p>
<h3 id="2、JDK8及以后-元空间">2、JDK8及以后(元空间)</h3>
<ol>
<li>元数据区大小可以使用参数 <strong>-XX:MetaspaceSize</strong> 和 <strong>-XX:MaxMetaspaceSize</strong> 指定</li>
<li>默认值依赖于平台，Windows下，-XX:MetaspaceSize 约为21M，-XX:MaxMetaspaceSize的值是-1，即没有限制。</li>
<li>与永久代不同，如果不指定大小，默认情况下，虚拟机会耗尽所有的可用系统内存。如果元数据区发生溢出，虚拟机一样会抛出异常OutOfMemoryError:Metaspace</li>
<li>-XX:MetaspaceSize：设置初始的元空间大小。对于一个 64位 的服务器端 JVM 来说，其默认的 -XX:MetaspaceSize值为21MB。这就是初始的<strong>高水位线</strong>，一旦触及这个水位线，Full GC将会被触发并卸载没用的类（即这些类对应的类加载器不再存活），然后这个高水位线将会重置。新的高水位线的值取决于GC后释放了多少元空间。如果释放的空间不足，那么在不超过MaxMetaspaceSize时，适当提高该值。如果释放空间过多，则适当降低该值。</li>
<li>如果初始化的高水位线设置过低，上述高水位线调整情况会发生很多次。通过垃圾回收器的日志可以观察到Full GC多次调用。为了避免频繁地GC，建议将-XX:MetaspaceSize设置为一个相对较高的值。</li>
</ol>
<h3 id="3、方法区OOM">3、方法区OOM</h3>
<p>代码：OOMTest 类继承 ClassLoader 类，获得 defineClass() 方法，可自己进行类的加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * jdk6/7中：</span><br><span class="hljs-comment"> * -XX:PermSize=10m -XX:MaxPermSize=10m</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * jdk8中：</span><br><span class="hljs-comment"> * -XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OOMTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">OOMTest</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OOMTest</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) &#123;<br>                <span class="hljs-comment">//创建ClassWriter对象，用于生成类的二进制字节码</span><br>                <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">classWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-comment">//指明版本号，修饰符，类名，包名，父类，接口</span><br>                classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="hljs-string">&quot;Class&quot;</span> + i, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">//返回byte[]</span><br>                <span class="hljs-type">byte</span>[] code = classWriter.toByteArray();<br>                <span class="hljs-comment">//类的加载</span><br>                test.defineClass(<span class="hljs-string">&quot;Class&quot;</span> + i, code, <span class="hljs-number">0</span>, code.length);<span class="hljs-comment">//Class对象</span><br>                j++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(j);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>不设置元空间的上限</strong></p>
<p>使用默认的 JVM 参数，元空间不设置上限</p>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">10000</span><br></code></pre></td></tr></table></figure>
<p><strong>设置元空间的上限</strong></p>
<p>JVM 参数</p>
<p>-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m</p>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">8531</span><br>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Metaspace<br>	at java.lang.ClassLoader.defineClass1(Native Method)<br>	at java.lang.ClassLoader.defineClass(ClassLoader.java:<span class="hljs-number">763</span>)<br>	at java.lang.ClassLoader.defineClass(ClassLoader.java:<span class="hljs-number">642</span>)<br>	at com.atguigu.java.OOMTest.main(OOMTest.java:<span class="hljs-number">29</span>)<br></code></pre></td></tr></table></figure>
<h3 id="4、如何解决OOM？">4、如何解决OOM？</h3>
<ol>
<li>要解决OOM异常或heap space的异常，一般的手段是首先通过<strong>内存映像分析工具</strong>（如Ec1ipse Memory Analyzer）对dump出来的堆转储快照进行分析，重点是确认内存中的对象是否是必要的，<strong>也就是要先分清楚到底是出现了内存泄漏（Memory Leak）还是内存溢出（Memory Overflow）</strong></li>
<li><strong>内存泄漏</strong>就是有大量的引用指向某些对象，但是这些对象以后不会使用了，但是因为它们还和GC ROOT有关联，所以导致以后这些对象也不会被回收，这就是内存泄漏的问题</li>
<li>如果是内存泄漏，可进一步通过工具查看泄漏对象到GC Roots的引用链。于是就能找到泄漏对象是通过怎样的路径与GC Roots相关联并导致垃圾收集器无法自动回收它们的。掌握了泄漏对象的类型信息，以及GC Roots引用链的信息，就可以比较准确地定位出泄漏代码的位置。</li>
<li>如果不存在内存泄漏，换句话说就是内存中的对象确实都还必须存活着，那就应当检查虚拟机的堆参数（-Xmx与-Xms），与机器物理内存对比看是否还可以调大，从代码上检查是否存在某些对象生命周期过长、持有状态时间过长的情况，尝试减少程序运行期的内存消耗。</li>
</ol>
<h2 id="4、方法区内部结构">4、方法区内部结构</h2>
<h3 id="1、方法区存储什么？">1、方法区存储什么？</h3>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308171307163.png" srcset="/img/loading.gif" lazyload alt></p>
<p>它用于存储已被虚拟机加载的<strong>类型信息、常量、静态变量、即时编译器编译后的代码缓存</strong>等。</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308171348710.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>类型信息</strong></p>
<p>对每个加载的类型（类class、接口interface、枚举enum、注解annotation），JVM必须在方法区中存储以下类型信息：</p>
<ol>
<li>这个类型的完整有效名称（全名=包名.类名）</li>
<li>这个类型直接父类的完整有效名（对于interface或是java.lang.Object，都没有父类）</li>
<li>这个类型的修饰符（public，abstract，final的某个子集）</li>
<li>这个类型直接接口的一个有序列表</li>
</ol>
<p><strong>域（Field）信息</strong></p>
<p>也就是成员变量，域信息是比较官方的称呼</p>
<ol>
<li>JVM必须在方法区中保存类型的所有域的相关信息以及域的声明顺序。</li>
<li>域的相关信息包括：域名称，域类型，域修饰符（public，private，protected，static，final，volatile，transient的某个子集）</li>
</ol>
<p><strong>方法（Method）信息</strong></p>
<p>JVM必须保存所有方法的以下信息，同域信息一样包括声明顺序：</p>
<ol>
<li>方法名称</li>
<li>方法的返回类型（包括 void 返回类型），void 在 Java 中对应的为 void.class</li>
<li>方法参数的数量和类型（按顺序）</li>
<li>方法的修饰符（public，private，protected，static，final，synchronized，native，abstract的一个子集）</li>
<li>方法的字节码（bytecodes）、操作数栈、局部变量表及大小（abstract和native方法除外）</li>
<li>异常表（abstract和native方法除外），异常表记录每个异常处理的开始位置、结束位置、代码处理在程序计数器中的偏移地址、被捕获的异常类的常量池索引</li>
</ol>
<h3 id="2、non-final-类型的类变量">2、non-final 类型的类变量</h3>
<ol>
<li>静态变量和类关联在一起，随着类的加载而加载，他们成为类数据在逻辑上的一部分</li>
<li>类变量被类的所有实例共享，即使没有类实例时，你也可以访问它</li>
</ol>
<p><strong>举例</strong></p>
<ol>
<li>如下代码所示，即使我们把order设置为null，也不会出现空指针异常</li>
<li>这更加表明了 static 类型的字段和方法随着类的加载而加载，并不属于特定的类实例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAreaTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        order.hello();<br>        System.out.println(order.count);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs code">hello!<br>1<br></code></pre></td></tr></table></figure>
<p><strong>全局常量</strong>：static final</p>
<ol>
<li>全局常量就是使用 static final 进行修饰</li>
<li>被声明为final的类变量的处理方法则不同，每个全局常量在编译的时候就会被分配了。</li>
</ol>
<p>查看上面代码，这部分的字节码指令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    ...<br>&#125;    <br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> count;<br>    descriptor: I<br>    flags: ACC_PUBLIC, ACC_STATIC<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> number;<br>    descriptor: I<br>    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL<br>    ConstantValue: <span class="hljs-type">int</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p>可以发现 staitc和final同时修饰的number 的值在编译上的时候已经写死在字节码文件中了。</p>
<h3 id="3、运行时常量池">3、运行时常量池</h3>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308172316645.png" srcset="/img/loading.gif" lazyload alt></p>
<ul>
<li>方法区，内部包含了运行时常量池</li>
<li>字节码文件，内部包含了常量池。（之前的字节码文件中已经看到了很多Constant pool的东西，这个就是常量池）</li>
<li>要弄清楚方法区，需要理解清楚ClassFile，因为加载类的信息都在方法区。</li>
<li>要弄清楚方法区的运行时常量池，需要理解清楚ClassFile中的常量池。</li>
</ul>
<p><strong>常量池</strong></p>
<ol>
<li>一个有效的字节码文件中除了包含类的版本信息、字段、方法以及接口等描述符信息外。还包含一项信息就是<strong>常量池表</strong>（<strong>Constant Pool Table</strong>），包括各种字面量和对类型、域和方法的符号引用。</li>
<li>字面量： 10 ， “我是某某”这种数字和字符串都是字面量</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308172826239.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>为什么需要常量池？</strong></p>
<p>一个java源文件中的类、接口，编译后产生一个字节码文件。而Java中的字节码需要数据支持，通常这种数据会很大以至于不能直接存到字节码里，换另一种方式，可以存到常量池。这个字节码包含了指向常量池的引用。在动态链接的时候会用到运行时常量池。</p>
<p>比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>虽然上述代码只有194字节，但是里面却使用了String、System、PrintStream及Object等结构。</li>
<li>比如说我们这个文件中有6个地方用到了”hello”这个字符串，如果不用常量池，就需要在6个地方全写一遍，造成臃肿。我们可以将”hello”等所需用到的结构信息记录在常量池中，并通过<strong>引用的方式</strong>，来加载、调用所需的结构</li>
<li>这里的代码量其实很少了，如果代码多的话，引用的结构将会更多，这里就需要用到常量池了。</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308173007613.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>常量池包含：</strong></p>
<ol>
<li>数量值</li>
<li>字符串值</li>
<li>类引用</li>
<li>字段引用</li>
<li>方法引用</li>
</ol>
<p>常量池、可以看做是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等类型。</p>
<p><strong>运行时常量池</strong></p>
<ol>
<li>运行时常量池（Runtime Constant Pool）是方法区的一部分。</li>
<li>常量池表（Constant Pool Table）是Class字节码文件的一部分，用于存放编译期生成的各种字面量与符号引用，<strong>这部分内容将在类加载后存放到方法区的运行时常量池中</strong>。（运行时常量池就是常量池在程序运行时的称呼）</li>
<li>运行时常量池，在加载类和接口到虚拟机后，就会创建对应的运行时常量池。</li>
<li>JVM为每个已加载的类型（类或接口）都维护一个常量池。池中的数据项像数组项一样，是通过索引访问的。</li>
<li>运行时常量池中包含多种不同的常量，包括编译期就已经明确的数值字面量，也包括到运行期解析后才能够获得的方法或者字段引用。<strong>此时不再是常量池中的符号地址了，这里换为真实地址</strong>。运行时常量池，相对于Class文件常量池的另一重要特征是：具备动态性。</li>
<li>运行时常量池类似于传统编程语言中的符号表（symbol table），但是它所包含的数据却比符号表要更加丰富一些。</li>
<li>当创建类或接口的运行时常量池时，如果构造运行时常量池所需的内存空间超过了方法区所能提供的最大值，则JVM会抛OutofMemoryError异常。</li>
</ol>
<h2 id="5、方法区使用举例">5、方法区使用举例</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAreaDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">500</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> x / y;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;<br>        System.out.println(a + b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.atguigu.java1.MethodAreaDemo<br>  minor version: <span class="hljs-number">0</span><br>  major version: <span class="hljs-number">51</span><br>  flags: ACC_PUBLIC, ACC_SUPER<br>Constant pool:<br>   #<span class="hljs-number">1</span> = Methodref          #<span class="hljs-number">5.</span>#<span class="hljs-number">24</span>         <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   #<span class="hljs-number">2</span> = Fieldref           #<span class="hljs-number">25.</span>#<span class="hljs-number">26</span>        <span class="hljs-comment">// java/lang/System.out:Ljava/io/PrintStream;</span><br>   #<span class="hljs-number">3</span> = Methodref          #<span class="hljs-number">27.</span>#<span class="hljs-number">28</span>        <span class="hljs-comment">// java/io/PrintStream.println:(I)V</span><br>   #<span class="hljs-number">4</span> = Class              #<span class="hljs-number">29</span>            <span class="hljs-comment">// com/atguigu/java1/MethodAreaDemo</span><br>   #<span class="hljs-number">5</span> = Class              #<span class="hljs-number">30</span>            <span class="hljs-comment">// java/lang/Object</span><br>   #<span class="hljs-number">6</span> = Utf8               &lt;init&gt;<br>   #<span class="hljs-number">7</span> = Utf8               ()V<br>   #<span class="hljs-number">8</span> = Utf8               Code<br>   #<span class="hljs-number">9</span> = Utf8               LineNumberTable<br>  #<span class="hljs-number">10</span> = Utf8               LocalVariableTable<br>  #<span class="hljs-number">11</span> = Utf8               <span class="hljs-built_in">this</span><br>  #<span class="hljs-number">12</span> = Utf8               Lcom/atguigu/java1/MethodAreaDemo;<br>  #<span class="hljs-number">13</span> = Utf8               main<br>  #<span class="hljs-number">14</span> = Utf8               ([Ljava/lang/String;)V<br>  #<span class="hljs-number">15</span> = Utf8               args<br>  #<span class="hljs-number">16</span> = Utf8               [Ljava/lang/String;<br>  #<span class="hljs-number">17</span> = Utf8               x<br>  #<span class="hljs-number">18</span> = Utf8               I<br>  #<span class="hljs-number">19</span> = Utf8               y<br>  #<span class="hljs-number">20</span> = Utf8               a<br>  #<span class="hljs-number">21</span> = Utf8               b<br>  #<span class="hljs-number">22</span> = Utf8               SourceFile<br>  #<span class="hljs-number">23</span> = Utf8               MethodAreaDemo.java<br>  #<span class="hljs-number">24</span> = NameAndType        #<span class="hljs-number">6</span>:#<span class="hljs-number">7</span>          <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  #<span class="hljs-number">25</span> = Class              #<span class="hljs-number">31</span>            <span class="hljs-comment">// java/lang/System</span><br>  #<span class="hljs-number">26</span> = NameAndType        #<span class="hljs-number">32</span>:#<span class="hljs-number">33</span>        <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>  #<span class="hljs-number">27</span> = Class              #<span class="hljs-number">34</span>            <span class="hljs-comment">// java/io/PrintStream</span><br>  #<span class="hljs-number">28</span> = NameAndType        #<span class="hljs-number">35</span>:#<span class="hljs-number">36</span>        <span class="hljs-comment">// println:(I)V</span><br>  #<span class="hljs-number">29</span> = Utf8               com/atguigu/java1/MethodAreaDemo<br>  #<span class="hljs-number">30</span> = Utf8               java/lang/Object<br>  #<span class="hljs-number">31</span> = Utf8               java/lang/System<br>  #<span class="hljs-number">32</span> = Utf8               out<br>  #<span class="hljs-number">33</span> = Utf8               Ljava/io/PrintStream;<br>  #<span class="hljs-number">34</span> = Utf8               java/io/PrintStream<br>  #<span class="hljs-number">35</span> = Utf8               println<br>  #<span class="hljs-number">36</span> = Utf8               (I)V<br>&#123;<br>  <span class="hljs-keyword">public</span> com.atguigu.java1.MethodAreaDemo();<br>    descriptor: ()V<br>    flags: ACC_PUBLIC<br>    Code:<br>      stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: aload_0<br>         <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span>                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">7</span>: <span class="hljs-number">0</span><br>      LocalVariableTable:<br>        Start  Length  Slot  Name   Signature<br>            <span class="hljs-number">0</span>       <span class="hljs-number">5</span>     <span class="hljs-number">0</span>  <span class="hljs-built_in">this</span>   Lcom/atguigu/java1/MethodAreaDemo;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      stack=<span class="hljs-number">3</span>, locals=<span class="hljs-number">5</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: sipush        <span class="hljs-number">500</span><br>         <span class="hljs-number">3</span>: istore_1<br>         <span class="hljs-number">4</span>: bipush        <span class="hljs-number">100</span><br>         <span class="hljs-number">6</span>: istore_2<br>         <span class="hljs-number">7</span>: iload_1<br>         <span class="hljs-number">8</span>: iload_2<br>         <span class="hljs-number">9</span>: idiv<br>        <span class="hljs-number">10</span>: istore_3<br>        <span class="hljs-number">11</span>: bipush        <span class="hljs-number">50</span><br>        <span class="hljs-number">13</span>: istore        <span class="hljs-number">4</span><br>        <span class="hljs-number">15</span>: getstatic     #<span class="hljs-number">2</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-number">18</span>: iload_3<br>        <span class="hljs-number">19</span>: iload         <span class="hljs-number">4</span><br>        <span class="hljs-number">21</span>: iadd<br>        <span class="hljs-number">22</span>: invokevirtual #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Method java/io/PrintStream.println:(I)V</span><br>        <span class="hljs-number">25</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">9</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">10</span>: <span class="hljs-number">4</span><br>        line <span class="hljs-number">11</span>: <span class="hljs-number">7</span><br>        line <span class="hljs-number">12</span>: <span class="hljs-number">11</span><br>        line <span class="hljs-number">13</span>: <span class="hljs-number">15</span><br>        line <span class="hljs-number">14</span>: <span class="hljs-number">25</span><br>      LocalVariableTable:<br>        Start  Length  Slot  Name   Signature<br>            <span class="hljs-number">0</span>      <span class="hljs-number">26</span>     <span class="hljs-number">0</span>  args   [Ljava/lang/String;<br>            <span class="hljs-number">4</span>      <span class="hljs-number">22</span>     <span class="hljs-number">1</span>     x   I<br>            <span class="hljs-number">7</span>      <span class="hljs-number">19</span>     <span class="hljs-number">2</span>     y   I<br>           <span class="hljs-number">11</span>      <span class="hljs-number">15</span>     <span class="hljs-number">3</span>     a   I<br>           <span class="hljs-number">15</span>      <span class="hljs-number">11</span>     <span class="hljs-number">4</span>     b   I<br>&#125;<br>SourceFile: <span class="hljs-string">&quot;MethodAreaDemo.java&quot;</span><br></code></pre></td></tr></table></figure>
<p><strong>图解字节码指令执行流程</strong></p>
<p>1、初始状态</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180004431.png" srcset="/img/loading.gif" lazyload alt></p>
<p>2、首先将操作数500压入操作数栈中</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180051615.png" srcset="/img/loading.gif" lazyload alt></p>
<p>3、然后操作数 500 从操作数栈中取出，存储到局部变量表中索引为 1 的位置</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180136460.png" srcset="/img/loading.gif" lazyload alt></p>
<p>4、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180202251.png" srcset="/img/loading.gif" lazyload alt></p>
<p>5、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180216598.png" srcset="/img/loading.gif" lazyload alt></p>
<p>6、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180242453.png" srcset="/img/loading.gif" lazyload alt></p>
<p>7、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180259205.png" srcset="/img/loading.gif" lazyload alt></p>
<p>8、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180314684.png" srcset="/img/loading.gif" lazyload alt></p>
<p>9、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180349731.png" srcset="/img/loading.gif" lazyload alt></p>
<p>10、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180403045.png" srcset="/img/loading.gif" lazyload alt></p>
<p>11、图片写错了是#25和#26（获得System类）</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180429925.png" srcset="/img/loading.gif" lazyload alt></p>
<p>12、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180442744.png" srcset="/img/loading.gif" lazyload alt></p>
<p>13、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180459139.png" srcset="/img/loading.gif" lazyload alt></p>
<p>14、执行加法运算后，将计算结果放在操作数栈顶</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180605746.png" srcset="/img/loading.gif" lazyload alt></p>
<p>15、就是真正的打印</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180646611.png" srcset="/img/loading.gif" lazyload alt></p>
<p>16、</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230308180703378.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>符号引用 –&gt; 直接饮用</strong></p>
<ol>
<li>上面代码调用 System.out.println() 方法时，首先需要看看 System 类有没有加载，再看看 PrintStream 类有没有加载</li>
<li>如果没有加载，则执行加载，执行时，将常量池中的符号引用（字面量）转换为运行时常量池的直接引用（真正的地址值）</li>
</ol>
<h2 id="6、方法区演进细节">6、方法区演进细节</h2>
<h3 id="1、永久代演进过程">1、永久代演进过程</h3>
<ol>
<li>首先明确：只有Hotspot才有永久代。BEA JRockit、IBMJ9等来说，是不存在永久代的概念的。原则上如何实现方法区属于虚拟机实现细节，不受《Java虚拟机规范》管束，并不要求统一</li>
<li>Hotspot中方法区的变化：</li>
</ol>
<table>
<thead>
<tr>
<th>JDK1.6及以前</th>
<th>有永久代（permanent generation），静态变量存储在永久代上</th>
</tr>
</thead>
<tbody>
<tr>
<td>JDK1.7</td>
<td>有永久代，但已经逐步 “去永久代”，<strong>字符串常量池，静态变量移除，保存在堆中</strong></td>
</tr>
<tr>
<td>JDK1.8</td>
<td>无永久代，类型信息，字段，方法，常量保存在本地内存的元空间，但字符串常量池、静态变量仍然在堆中。</td>
</tr>
</tbody>
</table>
<p><strong>JDK6</strong></p>
<p>方法区由永久代实现，使用 JVM 虚拟机内存（虚拟的内存）</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309122916648.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>JDK7</strong></p>
<p>方法区由永久代实现，使用 JVM 虚拟机内存</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309122933796.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>JDK8</strong></p>
<p>方法区由元空间实现，使用物理机本地内存</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309123036208.png" srcset="/img/loading.gif" lazyload alt></p>
<h3 id="2、永久代为什么要被元空间替代？">2、永久代为什么要被元空间替代？</h3>
<p>随着Java8的到来，HotSpot VM中再也见不到永久代了。但是这并不意味着类的元数据信息也消失了。这些数据被移到了一个与堆不相连的本地内存区域，这个区域叫做元空间（Metaspace）。由于类的元数据分配在本地内存中，元空间的最大可分配空间就是系统可用内存空间。</p>
<p>这项改动是很有必要的，原因有：</p>
<ol>
<li>为永久代设置空间大小是很难确定的。在某些场景下，如果动态加载类过多，容易产生Perm区的OOM。比如某个实际Web工程中，因为功能点比较多，在运行过程中，要不断动态加载很多类，经常出现致命错误。<code>Exception in thread 'dubbo client x.x connector' java.lang.OutOfMemoryError:PermGen space</code>而元空间和永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。 因此，默认情况下，元空间的大小仅受本地内存限制。</li>
<li>对永久代进行调优是很困难的。方法区的垃圾收集主要回收两部分内容：常量池中<strong>废弃的常量和不再用的类型</strong>，方法区的调优主要是为了降低Full GC
<ol>
<li>有些人认为方法区（如HotSpot虚拟机中的元空间或者永久代）是没有垃圾收集行为的，其实不然。《Java虚拟机规范》对方法区的约束是非常宽松的，提到过可以不要求虚拟机在方法区中实现垃圾收集。事实上也确实有未实现或未能完整实现方法区类型卸载的收集器存在（如JDK11时期的ZGC收集器就不支持类卸载）。</li>
<li>一般来说这个区域的回收效果比较难令人满意，尤其是类型的卸载，条件相当苛刻。但是这部分区域的回收有时又确实是必要的。以前Sun公司的Bug列表中，曾出现过的若干个严重的Bug就是由于低版本的HotSpot虚拟机对此区域未完全回收而导致内存泄漏。</li>
</ol>
</li>
</ol>
<h3 id="3、字符串常量池">3、字符串常量池</h3>
<p><strong>字符串常量池 StringTable 为什么要调整位置？</strong></p>
<ul>
<li>JDK7中将StringTable放到了堆空间中。因为永久代的回收效率很低，在Full GC的时候才会执行永久代的垃圾回收，而Full GC是老年代的空间不足、永久代不足时才会触发。</li>
<li>这就导致StringTable回收效率不高，而我们开发中会有大量的字符串被创建，回收效率低，导致永久代内存不足。放到堆里，能及时回收内存。</li>
</ul>
<h3 id="4、静态变量放在哪里">4、静态变量放在哪里</h3>
<p><strong>1、对象实体</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 结论：</span><br><span class="hljs-comment"> * 1、静态引用对应的对象实体(也就是这个new byte[1024 * 1024 * 100])始终都存在堆空间，</span><br><span class="hljs-comment"> * 2、只是那个变量(相当于下面的arr变量名)在JDK6,JDK7,JDK8存放位置中有所变化</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * jdk7：</span><br><span class="hljs-comment"> * -Xms200m -Xmx200m -XX:PermSize=300m -XX:MaxPermSize=300m -XX:+PrintGCDetails</span><br><span class="hljs-comment"> * jdk 8：</span><br><span class="hljs-comment"> * -Xms200m -Xmx200m -XX:MetaspaceSize=300m -XX:MaxMetaspaceSize=300m -XX:+PrintGCDetails</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticFieldTest</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">100</span>];<span class="hljs-comment">//100MB</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(StaticFieldTest.arr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>静态引用对应的对象实体(也就是这个new byte[1024 * 1024 * 100])<strong>始终都存在堆空间</strong>，只是那个变量(相当于下面的arr变量名)在JDK6,JDK7,JDK8存放位置中有所变化</p>
<p><strong>2、变量（名）</strong></p>
<p>这个问题需要用JHSDB工具来进行分析，这个工具是JDK9开始自带的(JDK9以前没有)，在bin目录下可以找到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.java1;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 《深入理解Java虚拟机》中的案例：</span><br><span class="hljs-comment"> * staticObj、instanceObj、localObj存放在哪里？</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticObjTest</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectHolder</span> <span class="hljs-variable">staticObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectHolder</span>();<br>        <span class="hljs-type">ObjectHolder</span> <span class="hljs-variable">instanceObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectHolder</span>();<br><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">ObjectHolder</span> <span class="hljs-variable">localObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectHolder</span>();<br>            System.out.println(<span class="hljs-string">&quot;done&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectHolder</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Test</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticObjTest</span>.Test();<br>        test.foo();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>JDK6环境下</strong></p>
<p>1、staticObj随着Test的类型信息存放在方法区</p>
<p>2、instanceObj随着Test的对象实例存放在Java堆</p>
<p>3、localObject则是存放在foo()方法栈帧的局部变量表中。</p>
<p>4、测试发现：三个对象的数据在内存中的地址都落在Eden区范围内，所以结论：<strong>只要是对象实例必然会在Java堆中分配</strong>。</p>
<h2 id="7、方法区的垃圾回收">7、方法区的垃圾回收</h2>
<p>方法区的垃圾收集主要回收两部分内容：<strong>常量池中废弃的常量和不再使用的类型</strong>。</p>
<ol>
<li>先来说说方法区内常量池之中主要存放的两大类常量：<strong>字面量和符号引用</strong>。字面量比较接近Java语言层次的常量概念，如文本字符串、被声明为final的常量值等。而符号引用则属于编译原理方面的概念，包括下面三类常量：
<ul>
<li>类和接口的全限定名</li>
<li>字段的名称和描述符</li>
<li>方法的名称和描述符</li>
</ul>
</li>
<li>HotSpot虚拟机对常量池的回收策略是很明确的，只要常量池中的常量没有被任何地方引用，就可以被回收。</li>
<li>回收废弃常量与回收Java堆中的对象非常类似。（关于常量的回收比较简单，重点是类的回收）</li>
</ol>
<p>下面也称作<strong>类卸载</strong></p>
<p>1、判定一个常量是否“废弃”还是相对简单，而要判定一个类型是否属于“不再被使用的类”的条件就比较苛刻了。需要同时满足下面三个条件：</p>
<ul>
<li>该类所有的实例都已经被回收，也就是Java堆中不存在该类及其任何派生子类的实例。</li>
<li>加载该类的类加载器已经被回收，这个条件除非是经过精心设计的可替换类加载器的场景，如OSGi、JSP的重加载等，否则<strong>通常是很难达成的</strong>。</li>
<li>该类对应的java.lang.Class对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li>
</ul>
<p>2、Java虚拟机被允许对满足上述三个条件的无用类进行回收，<strong>这里说的仅仅是“被允许”</strong>，而并不是和对象一样，没有引用了就必然会回收。关于是否要对类型进行回收，HotSpot虚拟机提供了<code>-Xnoclassgc</code>参数进行控制，还可以使用<code>-verbose:class</code> 以及 <code>-XX：+TraceClass-Loading</code>、<code>-XX：+TraceClassUnLoading</code>查看类加载和卸载信息</p>
<p>3、在大量使用反射、动态代理、CGLib等字节码框架，动态生成JSP以及OSGi这类频繁自定义类加载器的场景中，通常都需要Java虚拟机具备类型卸载的能力，以保证不会对方法区造成过大的内存压力。</p>
<h2 id="8、运行时数据区总结">8、运行时数据区总结</h2>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309125449719.png" srcset="/img/loading.gif" lazyload alt></p>
<h2 id="9、直接内存">9、直接内存</h2>
<h3 id="1、直接内存概述">1、直接内存概述</h3>
<ol>
<li>直接内存不是虚拟机运行时数据区的一部分，也不是《Java虚拟机规范》中定义的内存区域。直接内存是在Java堆外的、直接向系统申请的内存区间。来源于NIO，通过存在堆中的DirectByteBuffer操作Native内存</li>
<li>通常，访问直接内存的速度会优于Java堆。即读写性能高。因此出于性能考虑，读写频繁的场合可能会考虑使用直接内存。</li>
<li>Java的NIO库允许Java程序使用直接内存，用于数据缓冲区</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  IO                  NIO (New IO / Non-Blocking IO)</span><br><span class="hljs-comment"> *  byte[] / char[]     Buffer</span><br><span class="hljs-comment"> *  Stream              Channel</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 查看直接内存的占用与释放</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BufferTest</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BUFFER</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<span class="hljs-comment">//1GB</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-comment">//直接分配本地内存空间</span><br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(BUFFER);<br>        System.out.println(<span class="hljs-string">&quot;直接内存分配完毕，请求指示！&quot;</span>);<br><br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        scanner.next();<br><br>        System.out.println(<span class="hljs-string">&quot;直接内存开始释放！&quot;</span>);<br>        byteBuffer = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        scanner.next();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>直接占用了 1G 的本地内存</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309130424648.png" srcset="/img/loading.gif" lazyload alt></p>
<h3 id="2、BIO-与-NIO">2、BIO 与 NIO</h3>
<p><strong>非直接缓存区（BIO）</strong></p>
<p>原来采用BIO的架构，在读写本地文件时，我们需要从用户态切换成内核态</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309130904791.png" srcset="/img/loading.gif" lazyload alt></p>
<p><strong>直接缓冲区（NIO）</strong></p>
<p>NIO 直接操作物理磁盘，省去了中间过程</p>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309130923700.png" srcset="/img/loading.gif" lazyload alt></p>
<h3 id="3、直接内存与-OOM">3、直接内存与 OOM</h3>
<ol>
<li>直接内存也可能导致OutofMemoryError异常</li>
<li>由于直接内存在Java堆外，因此它的大小不会直接受限于-Xmx指定的最大堆大小，但是系统内存是有限的，Java堆和直接内存的总和依然受限于操作系统能给出的最大内存。</li>
<li>直接内存的缺点为：
<ul>
<li>分配回收成本较高</li>
<li>不受JVM内存回收管理</li>
</ul>
</li>
<li>直接内存大小可以通过MaxDirectMemorySize设置</li>
<li>如果不指定，默认与堆的最大值-Xmx参数值一致</li>
</ol>
<p><img src="/2023/03/03/jvm-06-fang-fa-qu/image-20230309131244337.png" srcset="/img/loading.gif" lazyload alt></p>
<h2 id="10、常见面试题">10、常见面试题</h2>
<ol>
<li>百度
<ul>
<li>三面：说一下JVM内存模型吧，有哪些区？分别干什么的？</li>
</ul>
</li>
<li>蚂蚁金服：
<ul>
<li>Java8的内存分代改进</li>
<li>JVM内存分哪几个区，每个区的作用是什么？</li>
<li>一面：JVM内存分布/内存结构？栈和堆的区别？堆的结构？为什么两个survivor区？</li>
<li>二面：Eden和survior的比例分配</li>
</ul>
</li>
<li>小米：
<ul>
<li>jvm内存分区，为什么要有新生代和老年代</li>
</ul>
</li>
<li>字节跳动：
<ul>
<li>二面：Java的内存分区</li>
<li>二面：讲讲vm运行时数据库区</li>
<li>什么时候对象会进入老年代？</li>
</ul>
</li>
<li>京东：
<ul>
<li>JVM的内存结构，Eden和Survivor比例。</li>
<li>JVM内存为什么要分成新生代，老年代，持久代。新生代中为什么要分为Eden和survivor。</li>
</ul>
</li>
<li>天猫：
<ul>
<li>一面：Jvm内存模型以及分区，需要详细到每个区放什么。</li>
<li>一面：JVM的内存模型，Java8做了什么改</li>
</ul>
</li>
<li>拼多多：
<ul>
<li>JVM内存分哪几个区，每个区的作用是什么？</li>
</ul>
</li>
<li>美团：
<ul>
<li>java内存分配</li>
<li>jvm的永久代中会发生垃圾回收吗？</li>
<li>一面：jvm内存分区，为什么要有新生代和老年代？</li>
</ul>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/JVM/" class="category-chain-item">JVM</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java/">#java</a>
      
        <a href="/tags/JVM/">#JVM</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>JVM-06-方法区</div>
      <div>https://bigotry-zb.github.io.git/2023/03/03/jvm-06-fang-fa-qu/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Zbiao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月3日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/04/jvm-07-dui-xiang-de-shi-li-hua-nei-cun-bu-ju-yu-fang-wen-ding-wei/" title="JVM-07-对象的实例化内存布局与访问定位">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JVM-07-对象的实例化内存布局与访问定位</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/02/jvm-05-dui/" title="JVM-05-堆">
                        <span class="hidden-mobile">JVM-05-堆</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>Copyright © 2022</span> <i class="iconfont icon-love"></i> <span>ZBiao’s Blog</span>

    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/diy/timeDate.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/jingtaisidai.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiantiao.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
